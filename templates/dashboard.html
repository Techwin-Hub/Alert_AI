{% extends "base.html" %}

{% block content %}
<div class="dashboard-header">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <h1 class="display-6">Surveillance Modules</h1>
        <div class="dashboard-controls">
            <button class="btn btn-outline-primary btn-sm" onclick="refreshAllModules()">
                <i class="fas fa-sync-alt me-1"></i>
                Refresh All
            </button>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoRefresh">
                <label class="form-check-label" for="autoRefresh">
                    Auto Refresh
                </label>
            </div>
        </div>
    </div>
</div>

<div class="surveillance-grid" id="surveillanceGrid">
    {% for module in modules %}
    <div class="card surveillance-card" data-module-id="{{ module.id }}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title">
                <i class="fas {{ module.icon }} me-2 text-primary"></i>
                {{ module.title }}
            </h5>
            <span class="badge status-badge status-{{ module.status }}">
                {% if module.status == 'safe' %}
                    <i class="fas fa-check-circle me-1"></i>No Threat
                {% elif module.status == 'warning' %}
                    <i class="fas fa-exclamation-triangle me-1"></i>Warning
                {% elif module.status == 'alert' %}
                    <i class="fas fa-exclamation-circle me-1"></i>Alert
                {% else %}
                    <i class="fas fa-times-circle me-1"></i>Offline
                {% endif %}
            </span>
        </div>
        
        <div class="card-body">
            <!-- Live Preview Section / File Upload Section -->
            <div class="preview-section" id="preview-section-{{ module.id }}">
                <div class="placeholder-preview">
                    <i class="fas fa-video fa-3x"></i>
                    <p>Live Video Feed</p>
                    <small>{{ module.description }}</small>
                </div>
                {% if module.id in ['ppe-detection', 'fire-smoke', 'weapon-detection'] %}
                <div class="file-upload-section" id="file-upload-{{ module.id }}" style="display: none;">
                    <input type="file" class="form-control form-control-sm mb-2" name="file" accept="image/*,video/*">
                    <button class="btn btn-success btn-sm w-100" onclick="uploadFile('{{ module.id }}')">
                        <i class="fas fa-upload me-1"></i>Upload and Detect
                    </button>
                    <div class="detection-results-preview mt-2" id="results-preview-{{ module.id }}">
                        <!-- Detection results will be shown here -->
                        <small class="text-muted">Upload an image or video to see detection results.</small>
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- Stats Section -->
            <div class="stats-row">
                <div class="stat-item">
                    <span class="stat-number alert-count" data-count="{{ module.alert_count }}">{{ module.alert_count }}</span>
                    <small class="stat-label">Alerts Today</small>
                </div>
                <div class="stat-item">
                    <span class="stat-number">24/7</span>
                    <small class="stat-label">Monitoring</small>
                </div>
            </div>
            
            <!-- Last Update -->
            <div class="text-center mb-3">
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    Last Update: <span class="last-update">{{ last_update }}</span>
                </small>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button class="btn btn-outline-secondary btn-sm" onclick="viewLogs('{{ module.id }}')">
                    <i class="fas fa-list me-1"></i>
                    View Logs
                </button>
                <button class="btn btn-primary btn-sm" onclick="liveView('{{ module.id }}')">
                    <i class="fas fa-eye me-1"></i>
                    Live View
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Status Summary -->
<div class="card mt-4">
    <div class="card-body">
        <h5 class="card-title mb-3">System Status Summary</h5>
        <div class="status-summary-grid">
            <div class="status-summary safe">
                <i class="fas fa-shield-alt fa-2x mb-2"></i>
                <h4 id="safeCount">0</h4>
                <small>Safe</small>
            </div>
            <div class="status-summary warning">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <h4 id="warningCount">0</h4>
                <small>Warnings</small>
            </div>
            <div class="status-summary alert">
                <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                <h4 id="alertCount">0</h4>
                <small>Alerts</small>
            </div>
            <div class="status-summary offline">
                <i class="fas fa-times-circle fa-2x mb-2"></i>
                <h4 id="offlineCount">0</h4>
                <small>Offline</small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard-specific JavaScript
let autoRefreshInterval;

// Initialize dashboard
document.addEventListener('DOMContentLoaded', function() {
    updateStatusSummary();
    
    // Auto refresh toggle
    document.getElementById('autoRefresh').addEventListener('change', function(e) {
        if (e.target.checked) {
            autoRefreshInterval = setInterval(refreshAllModules, 10000); // Refresh every 10 seconds
        } else {
            clearInterval(autoRefreshInterval);
        }
    });
});

// Refresh all modules
function refreshAllModules() {
    fetch('/api/status')
        .then(response => response.json())
        .then(modules => {
            modules.forEach(module => {
                updateModuleCard(module);
            });
            updateStatusSummary();
            showNotification('All modules refreshed successfully', 'success');
        })
        .catch(error => {
            console.error('Error refreshing modules:', error);
            showNotification('Error refreshing modules', 'danger');
        });
}

// Update individual module card
function updateModuleCard(module) {
    const card = document.querySelector(`[data-module-id="${module.id}"]`);
    if (!card) return;
    
    // Update status badge
    const statusBadge = card.querySelector('.status-badge');
    statusBadge.className = `badge status-badge status-${module.status}`;
    
    let badgeText = '';
    let badgeIcon = '';
    
    switch(module.status) {
        case 'safe':
            badgeText = 'No Threat';
            badgeIcon = 'fa-check-circle';
            break;
        case 'warning':
            badgeText = 'Warning';
            badgeIcon = 'fa-exclamation-triangle';
            break;
        case 'alert':
            badgeText = 'Alert';
            badgeIcon = 'fa-exclamation-circle';
            break;
        case 'offline':
            badgeText = 'Offline';
            badgeIcon = 'fa-times-circle';
            break;
    }
    
    statusBadge.innerHTML = `<i class="fas ${badgeIcon} me-1"></i>${badgeText}`;
    
    // Update alert count
    const alertCount = card.querySelector('.alert-count');
    alertCount.textContent = module.alert_count;
    alertCount.dataset.count = module.alert_count;
    
    // Update last update time
    const lastUpdate = card.querySelector('.last-update');
    lastUpdate.textContent = module.last_update;
    
    // Add animation
    card.classList.add('updated');
    setTimeout(() => card.classList.remove('updated'), 1000);
}

// Update status summary
function updateStatusSummary() {
    const cards = document.querySelectorAll('.surveillance-card');
    const counts = { safe: 0, warning: 0, alert: 0, offline: 0 };
    
    cards.forEach(card => {
        const statusBadge = card.querySelector('.status-badge');
        const status = statusBadge.className.match(/status-(\w+)/)[1];
        counts[status]++;
    });
    
    document.getElementById('safeCount').textContent = counts.safe;
    document.getElementById('warningCount').textContent = counts.warning;
    document.getElementById('alertCount').textContent = counts.alert;
    document.getElementById('offlineCount').textContent = counts.offline;
}

// View logs function
function viewLogs(moduleId) {
    showNotification(`Opening logs for ${moduleId}`, 'info');
    // Here you would typically open a modal or navigate to a logs page
}

// Live view function
function liveView(moduleId) {
    const targetedModules = ['ppe-detection', 'fire-smoke', 'weapon-detection'];
    if (targetedModules.includes(moduleId)) {
        const fileUploadSection = document.getElementById(`file-upload-${moduleId}`);
        const previewSection = document.getElementById(`preview-section-${moduleId}`);
        const placeholderPreview = previewSection.querySelector('.placeholder-preview');

        if (fileUploadSection) {
            const isHidden = fileUploadSection.style.display === 'none';
            fileUploadSection.style.display = isHidden ? 'block' : 'none';
            placeholderPreview.style.display = isHidden ? 'none' : 'flex'; // Or 'block' if it was originally block

            if(isHidden) {
                 showNotification(`File upload for ${moduleId} enabled.`, 'info');
            } else {
                 showNotification(`File upload for ${moduleId} disabled.`, 'info');
            }
        }
    } else {
        showNotification(`Opening live view for ${moduleId}`, 'info');
        // Standard live view for other modules (e.g., open a modal with live video feed)
    }
}

// Upload file function
function uploadFile(moduleId) {
    const fileInput = document.querySelector(`#file-upload-${moduleId} input[type="file"]`);
    const file = fileInput.files[0];
    const resultsPreview = document.getElementById(`results-preview-${moduleId}`);

    if (!file) {
        showNotification('Please select a file to upload.', 'warning');
        return;
    }

    resultsPreview.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Processing...';

    const formData = new FormData();
    formData.append('file', file);

    fetch(`/api/detect/${moduleId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        resultsPreview.innerHTML = ''; // Clear previous results or spinner

        const resultCard = document.createElement('div');
        resultCard.className = 'card shadow-sm';

        let content = `<div class="card-body">`;
        content += `<h6 class="card-title text-primary">Detection Results for ${moduleId}</h6>`;

        if (data.error) {
            content += `<p class="text-danger">${data.error}</p>`;
        } else {
            const timestamp = new Date(data.timestamp).toLocaleString();
            content += `<p class="card-text mb-1"><small class="text-muted">Timestamp: ${timestamp}</small></p>`;

            if (data.image_url) {
                const imgElement = document.createElement('img');
                imgElement.src = data.image_url;
                imgElement.className = 'img-fluid rounded mb-2';
                imgElement.style.maxHeight = '200px';
                resultsPreview.appendChild(imgElement); // Prepend image so it appears above text
            }

            if (data.detections && data.detections.length > 0) {
                content += '<ul class="list-group list-group-flush">';
                data.detections.forEach(det => {
                    content += `<li class="list-group-item d-flex justify-content-between align-items-center">
                                    ${det.label}
                                    <span class="badge bg-info rounded-pill">${(det.confidence * 100).toFixed(2)}%</span>
                                </li>`;
                });
                content += '</ul>';
            } else {
                content += '<p class="text-muted">No detections found.</p>';
            }
        }
        content += `</div>`;
        resultCard.innerHTML = content;
        resultsPreview.appendChild(resultCard);
        showNotification(`Detection complete for ${moduleId}`, 'success');
    })
    .catch(error => {
        console.error('Error uploading file:', error);
        resultsPreview.innerHTML = `<p class="text-danger">Error processing file: ${error.message}. Please try again.</p>`;
        showNotification(`Error processing file for ${moduleId}`, 'danger');
    });
}

// Show notification
function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto remove after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}
</script>
{% endblock %}